// ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à Web App URL –∑ Apps Script
const WEB_APP_URL = 'https://tts-proxy.nokuchishimo.workers.dev/';

// –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –º–æ–ª–∏—Ç–æ–≤
const DEFAULT_PRAYERS = {
    salmo23: {
        title: 'Salmo 23',
        text: `El Se√±or es mi pastor, nada me falta;
en verdes praderas me hace recostar.

Me conduce hacia fuentes tranquilas
y repara mis fuerzas;
me gu√≠a por el sendero justo,
por el honor de su nombre.

Aunque camine por ca√±adas oscuras,
nada temo, porque t√∫ vas conmigo:
tu vara y tu cayado me sosiegan.

Preparas una mesa ante m√≠,
enfrente de mis enemigos;
me unges la cabeza con perfume,
y mi copa rebosa.

Tu bondad y tu misericordia me acompa√±an
todos los d√≠as de mi vida,
y habitar√© en la casa del Se√±or
por a√±os sin t√©rmino.`
    },
    salmo91: {
        title: 'Salmo 91',
        text: `El que habita al abrigo del Alt√≠simo
morar√° bajo la sombra del Omnipotente.
Dir√© yo a Jehov√°: Esperanza m√≠a, y castillo m√≠o;
Mi Dios, en quien confiar√©.

El te librar√° del lazo del cazador,
De la peste destructora.
Con sus plumas te cubrar√°,
Y debajo de sus alas estar√°s seguro;
Escudo y adarga es su verdad.

No temer√°s el terror nocturno,
Ni saeta que vuele de d√≠a,
Ni pestilencia que ande en oscuridad,
Ni mortandad que en medio del d√≠a destruya.`
    },
    salmo121: {
        title: 'Salmo 121',
        text: `Alzar√© mis ojos a los montes;
¬øDe d√≥nde vendr√° mi socorro?
Mi socorro viene de Jehov√°,
Que hizo los cielos y la tierra.

No dar√° tu pie al resbaladero,
Ni se dormir√° el que te guarda.
He aqu√≠, no se adormecer√° ni dormir√°
El que guarda a Israel.`
    }
};

// ==================== localStorage –¥–ª—è –º–æ–ª–∏—Ç–æ–≤ ====================
class PrayerStorage {
    constructor() {
        this.storageKey = 'customPrayers';
    }
    getAll() {
        const data = localStorage.getItem(this.storageKey);
        return data ? JSON.parse(data) : {};
    }
    save(id, title, text) {
        const prayers = this.getAll();
        prayers[id] = { title, text };
        localStorage.setItem(this.storageKey, JSON.stringify(prayers));
    }
    delete(id) {
        const prayers = this.getAll();
        delete prayers[id];
        localStorage.setItem(this.storageKey, JSON.stringify(prayers));
    }
    getAllCombined() {
        return { ...DEFAULT_PRAYERS, ...this.getAll() };
    }
}

const prayerStorage = new PrayerStorage();

let currentAudio = null;
let currentPrayerId = 'salmo23';
let audioQueue = [];
let currentChunkIndex = 0;

// DOM –µ–ª–µ–º–µ–Ω—Ç–∏
const prayerSelect = document.getElementById('prayer-select');
const prayerTitle = document.getElementById('prayer-title');
const prayerText = document.getElementById('prayer-text');
const playButton = document.getElementById('playButton');
const stopButton = document.getElementById('stopButton');
const statusDiv = document.getElementById('status');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');

const customTitle = document.getElementById('custom-title');
const customText = document.getElementById('custom-text');
const charCount = document.getElementById('char-count');
const addPrayerBtn = document.getElementById('addPrayerBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const formStatus = document.getElementById('form-status');
const customPrayersContainer = document.getElementById('custom-prayers-container');

const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');

// ==================== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ ====================
document.addEventListener('DOMContentLoaded', async () => {
    loadPrayerSelect();
    loadPrayer('salmo23');
    updateCustomPrayersList();
});

// ==================== –í–∫–ª–∞–¥–∫–∏ ====================
tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
    });
});

// ==================== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–ª–∏—Ç–æ–≤ ====================
function loadPrayerSelect() {
    const allPrayers = prayerStorage.getAllCombined();
    prayerSelect.innerHTML = '';
    Object.keys(allPrayers).forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = allPrayers[id].title;
        prayerSelect.appendChild(option);
    });
}

function loadPrayer(id) {
    const allPrayers = prayerStorage.getAllCombined();
    const prayer = allPrayers[id];
    if (prayer) {
        currentPrayerId = id;
        prayerTitle.textContent = prayer.title;
        prayerText.textContent = prayer.text;
    }
}

prayerSelect.addEventListener('change', (e) => {
    loadPrayer(e.target.value);
    stopAudio();
});

// ==================== –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ ====================
playButton.addEventListener('click', async () => {
    const text = prayerText.textContent.trim();
    
    if (!text) {
        statusDiv.textContent = '‚ö†Ô∏è No hay texto para narrar';
        return;
    }
    
    playButton.disabled = true;
    playButton.textContent = '‚è≥ Cargando...';
    progressContainer.classList.add('active');
    updateProgress(0);
    
    try {
        statusDiv.innerHTML = '<span class="loader"></span>Generando audio...';
        
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        });

        const data = await response.json();
        
        if (data.success && Array.isArray(data.audioChunks) && data.audioChunks.length > 0) {
            audioQueue = data.audioChunks;
            currentChunkIndex = 0;
            
            statusDiv.textContent = `‚úÖ Reproduciendo ${data.audioChunks.length} fragmentos...`;
            playButton.textContent = '‚è∏Ô∏è Reproduciendo';
            stopButton.style.display = 'block';
            
            playNextChunk();
        } else {
            throw new Error('No se recibi√≥ audio del servidor');
        }
        
    } catch (error) {
        console.error('Error:', error);
        statusDiv.textContent = '‚ùå Error: ' + error.message;
        playButton.disabled = false;
        playButton.textContent = 'üîä Escuchar Oraci√≥n';
        progressContainer.classList.remove('active');
    }
});

function playNextChunk() {
    if (currentChunkIndex >= audioQueue.length) {
        // –í—Å—ñ —á–∞–Ω–∫–∏ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω—ñ
        statusDiv.textContent = '‚úÖ Reproducci√≥n completada';
        playButton.disabled = false;
        playButton.textContent = 'üîä Escuchar Oraci√≥n';
        stopButton.style.display = 'none';
        progressContainer.classList.remove('active');
        return;
    }
    
    const base64Audio = audioQueue[currentChunkIndex];
    const audioDataUrl = `data:audio/mpeg;base64,${base64Audio}`;
    
    currentAudio = new Audio(audioDataUrl);
    
    const progress = Math.round(((currentChunkIndex + 1) / audioQueue.length) * 100);
    updateProgress(progress);
    statusDiv.textContent = `üîä Reproduciendo fragmento ${currentChunkIndex + 1} de ${audioQueue.length}`;
    
    currentAudio.onended = () => {
        currentChunkIndex++;
        playNextChunk();
    };
    
    currentAudio.onerror = (e) => {
        console.error('Audio error:', e);
        statusDiv.textContent = '‚ùå Error al reproducir fragmento ' + (currentChunkIndex + 1);
        playButton.disabled = false;
        playButton.textContent = 'üîä Escuchar Oraci√≥n';
        stopButton.style.display = 'none';
        progressContainer.classList.remove('active');
    };
    
    currentAudio.play();
}

stopButton.addEventListener('click', stopAudio);

function stopAudio() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    audioQueue = [];
    currentChunkIndex = 0;
    statusDiv.textContent = '';
    playButton.disabled = false;
    playButton.textContent = 'üîä Escuchar Oraci√≥n';
    stopButton.style.display = 'none';
    progressContainer.classList.remove('active');
}

function updateProgress(percent) {
    progressBar.style.width = percent + '%';
    progressText.textContent = percent + '%';
}

// ==================== –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–æ–ª–∏—Ç–æ–≤ ====================
customText.addEventListener('input', () => {
    charCount.textContent = `${customText.value.length} caracteres`;
});

addPrayerBtn.addEventListener('click', () => {
    const title = customTitle.value.trim();
    const text = customText.value.trim();
    
    if (!title || !text) {
        formStatus.textContent = '‚ö†Ô∏è Por favor completa todos los campos';
        return;
    }
    
    const id = 'custom_' + Date.now();
    prayerStorage.save(id, title, text);
    
    customTitle.value = '';
    customText.value = '';
    charCount.textContent = '0 caracteres';
    formStatus.textContent = '‚úÖ Oraci√≥n guardada exitosamente';
    
    loadPrayerSelect();
    updateCustomPrayersList();
    
    setTimeout(() => formStatus.textContent = '', 3000);
});

clearFormBtn.addEventListener('click', () => {
    customTitle.value = '';
    customText.value = '';
    charCount.textContent = '0 caracteres';
});

function updateCustomPrayersList() {
    const customPrayers = prayerStorage.getAll();
    customPrayersContainer.innerHTML = '';
    
    if (Object.keys(customPrayers).length === 0) {
        customPrayersContainer.innerHTML = '<p style="color: #666; text-align: center;">No hay oraciones guardadas</p>';
        return;
    }
    
    Object.keys(customPrayers).forEach(id => {
        const prayer = customPrayers[id];
        const div = document.createElement('div');
        div.className = 'prayer-item';
        div.innerHTML = `
            <span class="prayer-item-title">${prayer.title}</span>
            <div class="prayer-item-actions">
                <button class="btn-small btn-use" onclick="usePrayer('${id}')">üìñ Usar</button>
                <button class="btn-small btn-delete" onclick="deletePrayer('${id}')">üóëÔ∏è</button>
            </div>
        `;
        customPrayersContainer.appendChild(div);
    });
}

window.usePrayer = (id) => {
    prayerSelect.value = id;
    loadPrayer(id);
    tabButtons[0].click();
};

window.deletePrayer = async (id) => {
    if (confirm('¬øEst√°s seguro de eliminar esta oraci√≥n?')) {
        prayerStorage.delete(id);
        loadPrayerSelect();
        updateCustomPrayersList();
    }
};
